<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria - Um Tempo Para a Paz</title>
    
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: 'Italiana' e 'Poppins' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fdfcfb;
            color: #3f3f46;
        }
        .font-title-stylized { font-family: 'Italiana', serif; }
        .page-gradient {
             background-image: 
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1c4c9' fill-opacity='0.07'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
                linear-gradient(to bottom, #fdfcfb 0%, #fdecf2 50%, #fdfcfb 100%);
        }
        .tab-active {
            border-bottom-color: #581c87;
            color: #3f3f46;
        }
    </style>
</head>
<body class="page-gradient">

    <!-- Menu de Navegação -->
    <nav class="bg-white/30 backdrop-blur-sm sticky top-0 z-50 shadow-sm border-y border-purple-900/10">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex items-center justify-center h-16">
                <div class="flex space-x-8 md:space-x-12 text-sm font-medium uppercase tracking-wider text-neutral-600">
                    <a href="index.html" class="hover:text-purple-900 transition-colors">Início</a>
                    <a href="programa.html" class="hover:text-purple-900 transition-colors">Programa</a>
                    <a href="galeria.html" class="hover:text-purple-900 transition-colors">Galeria</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-16 md:py-24">
        <div class="max-w-5xl mx-auto px-4">
            <header class="text-center mb-12">
                <h1 class="font-title-stylized text-5xl md:text-6xl text-neutral-800">Galeria de Memórias</h1>
                <p class="mt-4 text-lg text-neutral-600 font-light">As imagens e sentimentos que constroem a paz.</p>
            </header>

            <!-- Contêiner das Abas -->
            <div>
                <!-- Botões das Abas -->
                <div class="border-b border-gray-200 mb-8">
                    <nav class="-mb-px flex justify-center space-x-4 md:space-x-8" aria-label="Tabs">
                        <button class="tab-button tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-target="fotos-videos">Fotos & Vídeos</button>
                        <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:border-gray-300" data-target="painel-paz">Painel: "A Paz que Quero Construir"</button>
                    </nav>
                </div>

                <!-- Painéis de Conteúdo das Abas -->
                <div id="tab-content">
                    <!-- Painel 1: Fotos & Vídeos (Oficial) -->
                    <div id="fotos-videos" class="tab-panel space-y-12">
                        <!-- Seção de Fotos -->
                        <div>
                            <h3 class="text-xl font-semibold text-neutral-800 text-center mb-6">Fotos do Concerto</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+1" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+2" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+3" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+4" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+5" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                                <img src="https://placehold.co/600x600/fdecf2/3f3f46?text=Foto+6" class="rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                            </div>
                        </div>
                        
                        <!-- Seção de Vídeos -->
                        <div>
                            <h3 class="text-xl font-semibold text-neutral-800 text-center mb-6">Vídeos da Apresentação</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Vídeo 1 -->
                                <div class="aspect-video">
                                    <iframe class="w-full h-full rounded-lg shadow-md" src="https://www.youtube.com/embed/DnOJzC2S8SE?si=g8pUB-dbLxQepWGj" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                </div>
                                <!-- Vídeo 2 (Placeholder) -->
                                <div class="aspect-video">
                                    <iframe class="w-full h-full rounded-lg shadow-md" src="https://www.youtube.com/embed/YQ75rhS9Jz0?si=3TTjC_8cUB9YY0kk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Painel 2: Painel Interativo (Comunidade) -->
                    <div id="painel-paz" class="tab-panel hidden">
                        <!-- Formulário de Envio -->
                        <div class="p-8 bg-white/50 rounded-lg shadow-md border border-black/5 mb-12">
                             <form id="contribution-form">
                                <h3 class="text-xl font-semibold text-neutral-800 text-center mb-4">Participe do nosso painel!</h3>
                                <p class="text-center text-neutral-600 font-light mb-6">Envie uma foto e uma mensagem sobre o que a paz significa para si.</p>
                                <div class="space-y-4">
                                    <div>
                                        <label for="file-upload" class="block text-sm font-medium text-neutral-700">A sua foto</label>
                                        <input type="file" id="file-upload" accept="image/*" required class="mt-1 block w-full text-sm text-neutral-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    </div>
                                    <!-- Contêiner da Pré-visualização da Imagem -->
                                    <div id="image-preview-container" class="hidden mt-4">
                                        <p class="text-sm font-medium text-neutral-700 mb-2">Pré-visualização:</p>
                                        <img id="image-preview" src="#" alt="Pré-visualização da imagem" class="max-h-40 rounded-lg shadow-md mx-auto">
                                    </div>
                                    <div>
                                        <!-- Label e contador na mesma linha -->
                                        <div class="flex justify-between items-center">
                                            <label for="message" class="block text-sm font-medium text-neutral-700">A sua mensagem</label>
                                            <span id="char-counter" class="text-sm text-neutral-500">0 / 200</span>
                                        </div>
                                        <textarea id="message" rows="3" required maxlength="200" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="Escreva aqui o seu sentimento..."></textarea>
                                    </div>
                                    <button type="submit" id="submit-button" class="w-full bg-purple-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        Enviar Contribuição
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- Mural de Contribuições -->
                        <div id="mural" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <!-- Posts do público aparecerão aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-8 border-t border-purple-900/10"><p class="text-sm text-neutral-500">Asas da Paz Kotekitai & Taiyo Ongakutai © 2025</p></footer>
    
    <!-- Modal de Notificação -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="notification-message" class="text-neutral-700"></p>
            <button id="notification-close" class="mt-4 bg-purple-800 text-white font-bold py-2 px-4 rounded-lg w-full">Fechar</button>
        </div>
    </div>

    <!-- Firebase SDKs e Lógica de Dados -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- 1. CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- 2. AUTENTICAÇÃO ANÓNIMA ---
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                showNotification("Erro ao conectar. Por favor, tente recarregar a página.");
            }
        }

        // --- 3. MANIPULAÇÃO DO FORMULÁRIO ---
        const form = document.getElementById('contribution-form');
        const submitButton = document.getElementById('submit-button');
        const fileInput = document.getElementById('file-upload');
        const messageInput = document.getElementById('message');
        const mural = document.getElementById('mural');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) {
                showNotification("Ainda a conectar... Por favor, aguarde um momento.");
                return;
            }
            
            const file = fileInput.files[0];
            const message = messageInput.value;

            if (!file || !message) {
                showNotification("Por favor, selecione uma foto e escreva uma mensagem.");
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'A Enviar...';
            submitButton.classList.add('btn-loading');

            try {
                const storageRef = ref(storage, `public_gallery_images/${appId}/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const imageUrl = await getDownloadURL(snapshot.ref);

                await addDoc(collection(db, `/artifacts/${appId}/public/data/gallery`), {
                    message: message,
                    imageUrl: imageUrl,
                    createdAt: serverTimestamp() 
                });

                showNotification("A sua contribuição foi enviada com sucesso! Obrigado.");
                form.reset();

            } catch (error) {
                console.error("Erro ao enviar contribuição: ", error);
                showNotification("Ocorreu um erro. Por favor, tente novamente.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Contribuição';
                submitButton.classList.remove('btn-loading');
            }
        });

        // --- 4. EXIBIÇÃO EM TEMPO REAL ---
        function displayPost(doc) {
            const data = doc.data();
            const postDiv = document.createElement('div');
            postDiv.className = 'bg-white rounded-lg shadow-md overflow-hidden';
            
            const img = document.createElement('img');
            img.src = data.imageUrl;
            img.alt = 'Foto da contribuição';
            img.className = 'w-full h-40 object-cover';
            img.onerror = () => { img.src = 'https://placehold.co/600x400/a78bfa/ffffff?text=Imagem+Inválida'; };

            const messageDiv = document.createElement('div');
            messageDiv.className = 'p-4';
            const p = document.createElement('p');
            p.className = 'text-sm font-light text-neutral-600';
            p.textContent = data.message;
            
            messageDiv.appendChild(p);
            postDiv.appendChild(img);
            postDiv.appendChild(messageDiv);
            
            mural.appendChild(postDiv);
        }

        async function listenForPosts() {
             if (!auth.currentUser) { await authenticateUser(); }

            const q = query(collection(db, `/artifacts/${appId}/public/data/gallery`), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (querySnapshot) => {
                mural.innerHTML = ''; // Limpa o mural para evitar duplicados
                if (querySnapshot.empty) {
                    mural.innerHTML = '<p class="text-center text-neutral-500 col-span-full">Ainda ninguém partilhou a sua paz. Seja o primeiro!</p>';
                } else {
                    querySnapshot.forEach(displayPost);
                }
            }, (error) => {
                console.error("Erro ao escutar por posts:", error);
                showNotification("Não foi possível carregar as contribuições.");
            });
        }
        
        // --- 5. MODAL DE NOTIFICAÇÃO ---
        const modal = document.getElementById('notification-modal');
        const modalMessage = document.getElementById('notification-message');
        const modalCloseBtn = document.getElementById('notification-close');

        function showNotification(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // --- INICIAR A APLICAÇÃO ---
        listenForPosts();

    </script>
    
    <!-- Lógica de UI (Separada para robustez) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lógica das Abas
            const tabs = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => { 
                        item.classList.remove('tab-active'); 
                        item.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300'); 
                    });
                    tab.classList.add('tab-active');
                    tab.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300');
                    
                    tabPanels.forEach(panel => { 
                        panel.classList.add('hidden'); 
                    });
                    
                    const targetPanelId = tab.getAttribute('data-target');
                    const targetPanel = document.getElementById(targetPanelId);
                    if (targetPanel) { 
                        targetPanel.classList.remove('hidden'); 
                    }
                });
            });

            // Lógica da Pré-visualização da Imagem
            const fileInputUI = document.getElementById('file-upload');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImage = document.getElementById('image-preview');

            fileInputUI.addEventListener('change', () => {
                const file = fileInputUI.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            });

            // Lógica do Contador de Caracteres
            const messageInputUI = document.getElementById('message');
            const charCounter = document.getElementById('char-counter');
            const maxLength = messageInputUI.getAttribute('maxlength');

            messageInputUI.addEventListener('input', () => {
                const currentLength = messageInputUI.value.length;
                charCounter.textContent = `${currentLength} / ${maxLength}`;

                if (currentLength > maxLength * 0.9) {
                    charCounter.classList.add('text-red-500');
                } else {
                    charCounter.classList.remove('text-red-500');
                }
            });
            
            // Limpa a pré-visualização e o contador quando o formulário é resetado
            const formUI = document.getElementById('contribution-form');
            formUI.addEventListener('reset', () => {
                previewContainer.classList.add('hidden');
                charCounter.textContent = `0 / ${maxLength}`;
                charCounter.classList.remove('text-red-500');
            });
        });
    </script>

</body>
</html>
